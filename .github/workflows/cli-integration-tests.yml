# This workflow runs jfrog-cli integration tests against changes in jfrog-cli-artifactory.
# It allows validating that changes to this module don't break the CLI without creating a PR on jfrog-cli.
#
# How it works:
# 1. Clones jfrog-cli repository
# 2. Replaces the jfrog-cli-artifactory dependency with the PR branch using go mod replace
# 3. Installs a local Artifactory instance
# 4. Runs the specified CLI integration tests
#
# Trigger: 
# - Automatically on every push to a PR branch targeting main
# - On push to main
# - Manual dispatch for specific test suites
name: CLI Integration Tests
on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run (artifactory, npm, maven, gradle, go, conan, helm, nuget, pip, docker)'
        required: false
        default: 'artifactory'
        type: choice
        options:
          - artifactory
          - npm
          - maven
          - gradle
          - go
          - conan
          - helm
          - nuget
          - pip
          - docker
      jfrog_cli_branch:
        description: 'jfrog-cli branch to test against (default: master)'
        required: false
        default: 'master'
        type: string
  push:
    branches:
      - "main"
  # Triggers on every push to PR branches targeting main
  pull_request:
    branches:
      - "main"

# Ensures that only the latest commit is running for each PR at a time.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  CLI-Integration-Tests:
    name: CLI ${{ matrix.suite }} Tests (${{ matrix.os.name }})
    # Runs on: manual dispatch, push to main, or any push to a PR branch
    strategy:
      fail-fast: false
      matrix:
        suite: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', inputs.test_suite)) || fromJSON('["artifactory"]') }}
        os:
          - name: ubuntu
            version: 24.04
    runs-on: ${{ matrix.os.name }}-${{ matrix.os.version }}
    env:
      JFROG_CLI_LOG_LEVEL: DEBUG
      GOPROXY: direct
    steps:
      - name: Checkout jfrog-cli-artifactory (this repo - your PR branch)
        uses: actions/checkout@v5
        with:
          # For pull_request events, this checks out the PR head (your changes)
          # For push events, this checks out the pushed commit
          path: jfrog-cli-artifactory

      - name: Checkout jfrog-cli
        uses: actions/checkout@v5
        with:
          repository: jfrog/jfrog-cli
          ref: ${{ inputs.jfrog_cli_branch || 'master' }}
          path: jfrog-cli

      - name: Setup Go with cache
        uses: jfrog/.github/actions/install-go-with-cache@main

      # Replace jfrog-cli-artifactory dependency with the PR version
      - name: Replace jfrog-cli-artifactory dependency
        working-directory: jfrog-cli
        run: |
          echo "Replacing jfrog-cli-artifactory with local version from PR..."
          
          # Get the absolute path to the checked out jfrog-cli-artifactory
          ARTIFACTORY_PATH=$(cd ../jfrog-cli-artifactory && pwd)
          
          # Add replace directive to go.mod
          echo "" >> go.mod
          echo "replace github.com/jfrog/jfrog-cli-artifactory => ${ARTIFACTORY_PATH}" >> go.mod
          
          echo "Updated go.mod with replace directive:"
          tail -5 go.mod
          
          # Update dependencies
          go mod tidy

      - name: Verify dependency replacement
        working-directory: jfrog-cli
        run: |
          echo "Verifying go.mod..."
          cat go.mod | grep -A2 "jfrog-cli-artifactory" || echo "Dependency found"
          echo ""
          echo "Running go mod graph for jfrog-cli-artifactory..."
          go mod graph | grep "jfrog-cli-artifactory" | head -5 || echo "Dependency in graph"

      - name: Install local Artifactory
        uses: jfrog/.github/actions/install-local-artifactory@main
        with:
          RTLIC: ${{ secrets.RTLIC }}
          RT_CONNECTION_TIMEOUT_SECONDS: '1200'

      - name: Run CLI Integration Tests
        working-directory: jfrog-cli
        run: |
          echo "Running ${{ matrix.suite }} tests..."
          go test -v github.com/jfrog/jfrog-cli --timeout 0 \
            --test.${{ matrix.suite }} \
            --jfrog.url=http://127.0.0.1:8082 \
            --jfrog.adminToken=${{ env.JFROG_TESTS_LOCAL_ACCESS_TOKEN }} \
            --ci.runId=${{ runner.os }}-${{ matrix.suite }}-artifactory-pr
