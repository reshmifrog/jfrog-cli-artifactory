# ============================================================================
# CLI Integration Tests Trigger
# ============================================================================
# 
# This workflow triggers jfrog-cli's integration tests using your PR changes.
# It reads the replace directives from your go.mod and passes them to the
# jfrog-cli reusable workflow.
#
# How it works:
# 1. Detects replace directives in your jfrog-cli-artifactory go.mod
# 2. Calls jfrog-cli's reusable integration test workflow
# 3. The jfrog-cli workflow uses YOUR code via the replace directives
# 4. Results appear directly in this PR
#
# No PRs are created on jfrog-cli - all testing happens here!
#
# Requirements:
# - Add the "safe to test" label to trigger the tests
#
# ============================================================================

name: CLI Integration Tests

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'artifactory'
        type: choice
        options:
          - artifactory
          - npm
          - maven
          - gradle
          - go
          - conan
          - helm
          - nuget
          - pip
  pull_request_target:
    branches:
      - main
      - master
    types: [labeled, opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Job 1: Detect replace directives from go.mod
  # ============================================================================
  detect-replaces:
    name: Detect Replace Directives
    # Only run if:
    # - workflow_dispatch (manual trigger), OR
    # - PR has the "safe to test" label
    if: >
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'safe to test')
    runs-on: ubuntu-latest
    outputs:
      artifactory_replace: ${{ steps.detect.outputs.artifactory_replace }}
      build_info_replace: ${{ steps.detect.outputs.build_info_replace }}
      client_go_replace: ${{ steps.detect.outputs.client_go_replace }}
      cli_core_replace: ${{ steps.detect.outputs.cli_core_replace }}
    steps:
      - name: Checkout jfrog-cli-artifactory
        uses: actions/checkout@v5
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Detect replace directives
        id: detect
        run: |
          echo "============================================"
          echo "Parsing go.mod for replace directives..."
          echo "============================================"
          
          # Function to extract replace target
          # Input: "github.com/jfrog/xxx => github.com/user/xxx v0.0.0-..."
          # Output: "user/xxx v0.0.0-..."
          extract_replace() {
            local module=$1
            local line=$(grep "^replace github.com/jfrog/$module " go.mod 2>/dev/null | head -1)
            if [ -n "$line" ]; then
              # Extract the part after "=> github.com/"
              echo "$line" | sed -n 's/.*=> github.com\/\(.*\)/\1/p'
            fi
          }
          
          echo ""
          echo "Current go.mod replace directives:"
          grep "^replace " go.mod || echo "(no replace directives found)"
          echo ""
          
          # Always set artifactory replace to this PR
          # Format: owner/repo v0.0.0-timestamp-commit
          PR_OWNER="${{ github.event.pull_request.head.repo.owner.login || github.repository_owner }}"
          PR_REPO="jfrog-cli-artifactory"
          COMMIT_SHA="${{ github.event.pull_request.head.sha || github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:12}"
          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          
          ARTIFACTORY_REPLACE="${PR_OWNER}/${PR_REPO} v0.0.0-${TIMESTAMP}-${SHORT_SHA}"
          echo "artifactory_replace=${ARTIFACTORY_REPLACE}" >> $GITHUB_OUTPUT
          echo "✅ jfrog-cli-artifactory => ${ARTIFACTORY_REPLACE}"
          
          # Check for build-info-go replace
          BUILD_INFO=$(extract_replace "build-info-go")
          if [ -n "$BUILD_INFO" ]; then
            echo "build_info_replace=${BUILD_INFO}" >> $GITHUB_OUTPUT
            echo "✅ build-info-go => ${BUILD_INFO}"
          else
            echo "build_info_replace=" >> $GITHUB_OUTPUT
            echo "⏭️  build-info-go: using default"
          fi
          
          # Check for jfrog-client-go replace
          CLIENT_GO=$(extract_replace "jfrog-client-go")
          if [ -n "$CLIENT_GO" ]; then
            echo "client_go_replace=${CLIENT_GO}" >> $GITHUB_OUTPUT
            echo "✅ jfrog-client-go => ${CLIENT_GO}"
          else
            echo "client_go_replace=" >> $GITHUB_OUTPUT
            echo "⏭️  jfrog-client-go: using default"
          fi
          
          # Check for jfrog-cli-core replace
          CLI_CORE=$(extract_replace "jfrog-cli-core")
          if [ -n "$CLI_CORE" ]; then
            echo "cli_core_replace=${CLI_CORE}" >> $GITHUB_OUTPUT
            echo "✅ jfrog-cli-core => ${CLI_CORE}"
          else
            echo "cli_core_replace=" >> $GITHUB_OUTPUT
            echo "⏭️  jfrog-cli-core: using default"
          fi
          
          echo ""
          echo "============================================"
          echo "Detection complete!"
          echo "============================================"

  # ============================================================================
  # Job 2: Call jfrog-cli's reusable integration test workflow
  # ============================================================================
  run-integration-tests:
    name: Run Integration Tests (${{ matrix.suite }})
    needs: detect-replaces
    strategy:
      fail-fast: false
      matrix:
        suite:
          - artifactory
          - npm
          - maven
          - gradle
    # Using your forked repo for testing - change to jfrog/jfrog-cli when ready
    uses: reshmifrog/jfrog-cli/.github/workflows/integration-tests-reusable.yml@reusable-integration-tests
    with:
      test_suite: ${{ matrix.suite }}
      artifactory_replace: ${{ needs.detect-replaces.outputs.artifactory_replace }}
      build_info_replace: ${{ needs.detect-replaces.outputs.build_info_replace }}
      client_go_replace: ${{ needs.detect-replaces.outputs.client_go_replace }}
      cli_core_replace: ${{ needs.detect-replaces.outputs.cli_core_replace }}
    secrets: inherit
